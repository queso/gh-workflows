name: Lighthouse CI

on:
  workflow_call:
    inputs:
      target_url:
        description: 'The URL to run Lighthouse against'
        required: true
        type: string
      deployment_id:
        description: 'The deployment ID to find the associated PR'
        required: true
        type: number

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      deployments: read
    steps:
      - uses: actions/checkout@v4

      - name: Run Lighthouse
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: ${{ inputs.target_url }}
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Format Lighthouse Score
        id: format
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find the Lighthouse results file
            const lhciDir = '.lighthouseci';
            const files = fs.readdirSync(lhciDir);
            const lhrFile = files.find(f => f.startsWith('lhr-') && f.endsWith('.json'));

            if (!lhrFile) {
              core.setFailed('Could not find Lighthouse results file');
              return;
            }

            const results = JSON.parse(fs.readFileSync(path.join(lhciDir, lhrFile), 'utf8'));
            const categories = results.categories;

            const score = (val) => Math.round(val * 100);
            const emoji = (val) => val >= 0.9 ? 'ðŸŸ¢' : val >= 0.5 ? 'ðŸŸ ' : 'ðŸ”´';

            const comment = [
              '## âš¡ Lighthouse Report',
              '',
              '| Category | Score |',
              '|----------|-------|',
              `| ${emoji(categories.performance.score)} Performance | ${score(categories.performance.score)} |`,
              `| ${emoji(categories.accessibility.score)} Accessibility | ${score(categories.accessibility.score)} |`,
              `| ${emoji(categories['best-practices'].score)} Best Practices | ${score(categories['best-practices'].score)} |`,
              `| ${emoji(categories.seo.score)} SEO | ${score(categories.seo.score)} |`,
              '',
              `ðŸ”— [Preview](${process.env.DEPLOY_URL})`
            ].join('\n');

            core.setOutput('comment', comment);
        env:
          DEPLOY_URL: ${{ inputs.target_url }}

      - name: Find PR Number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.getDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ inputs.deployment_id }}
            });
            const ref = deployment.data.ref;
            const sha = deployment.data.sha;

            console.log(`Deployment ref: ${ref}`);
            console.log(`Deployment sha: ${sha}`);

            // Try finding PR by commit SHA first (more reliable)
            const prsForCommit = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha
            });

            if (prsForCommit.data.length > 0) {
              const pr = prsForCommit.data.find(p => p.state === 'open') || prsForCommit.data[0];
              console.log(`Found PR #${pr.number} via commit SHA`);
              core.setOutput('number', pr.number);
              return;
            }

            // Fallback: try by branch name
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${ref}`,
              state: 'open'
            });

            if (prs.data.length > 0) {
              console.log(`Found PR #${prs.data[0].number} via branch name`);
              core.setOutput('number', prs.data[0].number);
            } else {
              console.log('No PR found for this deployment');
            }

      - name: Post Comment
        if: steps.pr.outputs.number
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ steps.pr.outputs.number }}
          body: ${{ steps.format.outputs.comment }}
