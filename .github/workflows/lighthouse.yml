name: Lighthouse CI

on:
  workflow_call:
    inputs:
      target_url:
        description: 'The URL to run Lighthouse against'
        required: true
        type: string
      deployment_id:
        description: 'The deployment ID to find the associated PR'
        required: true
        type: number

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      deployments: read
    steps:
      - uses: actions/checkout@v4

      - name: Run Lighthouse
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: ${{ inputs.target_url }}
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Format Lighthouse Score
        id: format
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find the Lighthouse results file
            const lhciDir = '.lighthouseci';
            const files = fs.readdirSync(lhciDir);
            const lhrFile = files.find(f => f.startsWith('lhr-') && f.endsWith('.json'));

            if (!lhrFile) {
              core.setFailed('Could not find Lighthouse results file');
              return;
            }

            const results = JSON.parse(fs.readFileSync(path.join(lhciDir, lhrFile), 'utf8'));
            const { categories, audits } = results;

            const score = (val) => Math.round(val * 100);
            const emoji = (val) => val >= 0.9 ? 'ðŸŸ¢' : val >= 0.5 ? 'ðŸŸ ' : 'ðŸ”´';
            const THRESHOLD = 0.85;

            const lines = [
              '## âš¡ Lighthouse Report',
              '',
              '| Category | Score |',
              '|----------|-------|',
              `| ${emoji(categories.performance.score)} Performance | ${score(categories.performance.score)} |`,
              `| ${emoji(categories.accessibility.score)} Accessibility | ${score(categories.accessibility.score)} |`,
              `| ${emoji(categories['best-practices'].score)} Best Practices | ${score(categories['best-practices'].score)} |`,
              `| ${emoji(categories.seo.score)} SEO | ${score(categories.seo.score)} |`,
            ];

            // Add diagnostics for categories below threshold
            const diagnostics = [];

            // Performance diagnostics
            if (categories.performance.score < THRESHOLD) {
              const perfDiag = ['', '### Performance'];

              // Key metrics
              const metrics = [
                ['First Contentful Paint', audits['first-contentful-paint']?.displayValue],
                ['Largest Contentful Paint', audits['largest-contentful-paint']?.displayValue],
                ['Total Blocking Time', audits['total-blocking-time']?.displayValue],
                ['Cumulative Layout Shift', audits['cumulative-layout-shift']?.displayValue],
              ].filter(([_, v]) => v);

              if (metrics.length) {
                perfDiag.push('**Metrics:** ' + metrics.map(([k, v]) => `${k}: ${v}`).join(' Â· '));
              }

              // Top opportunities
              const opportunities = Object.values(audits)
                .filter(a => a.details?.overallSavingsMs > 100)
                .sort((a, b) => b.details.overallSavingsMs - a.details.overallSavingsMs)
                .slice(0, 3)
                .map(a => `- ${a.title} (${Math.round(a.details.overallSavingsMs)}ms)`);

              if (opportunities.length) {
                perfDiag.push('', '**Opportunities:**', ...opportunities);
              }

              diagnostics.push(...perfDiag);
            }

            // Accessibility diagnostics
            if (categories.accessibility.score < THRESHOLD) {
              const a11yIssues = Object.values(audits)
                .filter(a => a.scoreDisplayMode === 'binary' && a.score === 0 &&
                  categories.accessibility.auditRefs?.some(r => r.id === a.id))
                .slice(0, 5)
                .map(a => `- ${a.title}`);

              if (a11yIssues.length) {
                diagnostics.push('', '### Accessibility', ...a11yIssues);
              }
            }

            // Best Practices diagnostics
            if (categories['best-practices'].score < THRESHOLD) {
              const bpIssues = Object.values(audits)
                .filter(a => a.scoreDisplayMode === 'binary' && a.score === 0 &&
                  categories['best-practices'].auditRefs?.some(r => r.id === a.id))
                .slice(0, 5)
                .map(a => `- ${a.title}`);

              if (bpIssues.length) {
                diagnostics.push('', '### Best Practices', ...bpIssues);
              }
            }

            // SEO diagnostics
            if (categories.seo.score < THRESHOLD) {
              const seoIssues = Object.values(audits)
                .filter(a => a.scoreDisplayMode === 'binary' && a.score === 0 &&
                  categories.seo.auditRefs?.some(r => r.id === a.id))
                .slice(0, 5)
                .map(a => `- ${a.title}`);

              if (seoIssues.length) {
                diagnostics.push('', '### SEO', ...seoIssues);
              }
            }

            if (diagnostics.length) {
              lines.push('', '<details>', '<summary>Issues to address</summary>', ...diagnostics, '', '</details>');
            }

            lines.push('', `ðŸ”— [Preview](${process.env.DEPLOY_URL})`);

            core.setOutput('comment', lines.join('\n'));
        env:
          DEPLOY_URL: ${{ inputs.target_url }}

      - name: Find PR Number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.getDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ inputs.deployment_id }}
            });
            const ref = deployment.data.ref;
            const sha = deployment.data.sha;

            console.log(`Deployment ref: ${ref}`);
            console.log(`Deployment sha: ${sha}`);

            // Try finding PR by commit SHA first (more reliable)
            const prsForCommit = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha
            });

            if (prsForCommit.data.length > 0) {
              const pr = prsForCommit.data.find(p => p.state === 'open') || prsForCommit.data[0];
              console.log(`Found PR #${pr.number} via commit SHA`);
              core.setOutput('number', pr.number);
              return;
            }

            // Fallback 1: try by branch name (ref may be branch or SHA)
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${ref}`,
              state: 'open'
            });

            if (prs.data.length > 0) {
              console.log(`Found PR #${prs.data[0].number} via branch name`);
              core.setOutput('number', prs.data[0].number);
              return;
            }

            // Fallback 2: resolve branches containing this SHA, then find PR
            // Vercel sets deployment ref to commit SHA, not branch name
            const branches = await github.rest.repos.listBranchesForHeadCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha
            });

            for (const branch of branches.data) {
              const branchPrs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch.name}`,
                state: 'open'
              });
              if (branchPrs.data.length > 0) {
                console.log(`Found PR #${branchPrs.data[0].number} via branch ${branch.name}`);
                core.setOutput('number', branchPrs.data[0].number);
                return;
              }
            }

            console.log('No PR found for this deployment');

      - name: Post Comment
        if: steps.pr.outputs.number
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ steps.pr.outputs.number }}
          body: ${{ steps.format.outputs.comment }}
